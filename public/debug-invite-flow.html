<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>招待フローデバッグツール</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
    }
    h1, h2, h3 {
      color: #333;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }
    button {
      background-color: #4CAF50;
      border: none;
      color: white;
      padding: 10px 20px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 16px;
      margin: 10px 2px;
      cursor: pointer;
      border-radius: 4px;
    }
    button:hover {
      background-color: #45a049;
    }
    button.secondary {
      background-color: #2196F3;
    }
    button.secondary:hover {
      background-color: #0b7dda;
    }
    button.danger {
      background-color: #f44336;
    }
    button.danger:hover {
      background-color: #d32f2f;
    }
    pre {
      background-color: #f5f5f5;
      padding: 15px;
      border-radius: 5px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .result {
      margin-top: 20px;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 5px;
      border-left: 4px solid #4CAF50;
    }
    .error {
      border-left: 4px solid #f44336;
    }
    .warning {
      border-left: 4px solid #ff9800;
    }
    .info {
      border-left: 4px solid #2196F3;
    }
    .log-container {
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 20px;
    }
    .log-entry {
      margin-bottom: 5px;
      padding: 5px;
      border-radius: 3px;
    }
    .log-entry.debug {
      background-color: #e3f2fd;
    }
    .log-entry.info {
      background-color: #e8f5e9;
    }
    .log-entry.warn {
      background-color: #fff3e0;
    }
    .log-entry.error {
      background-color: #ffebee;
    }
    .tab-container {
      margin-top: 20px;
    }
    .tab-buttons {
      display: flex;
      border-bottom: 1px solid #ccc;
    }
    .tab-button {
      padding: 10px 20px;
      cursor: pointer;
      background-color: #f1f1f1;
      border: none;
      outline: none;
      margin-right: 2px;
      border-radius: 5px 5px 0 0;
    }
    .tab-button.active {
      background-color: #4CAF50;
      color: white;
    }
    .tab-content {
      display: none;
      padding: 20px;
      border: 1px solid #ccc;
      border-top: none;
    }
    .tab-content.active {
      display: block;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    th, td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    th {
      background-color: #f2f2f2;
    }
    tr:hover {
      background-color: #f5f5f5;
    }
  </style>
</head>
<body>
  <h1>招待フローデバッグツール</h1>
  <p>このツールは、招待フローの無限ループを診断・修正するためのものです。</p>
  
  <div class="tab-container">
    <div class="tab-buttons">
      <button class="tab-button active" onclick="openTab(event, 'diagnosis')">診断</button>
      <button class="tab-button" onclick="openTab(event, 'fix')">修正</button>
      <button class="tab-button" onclick="openTab(event, 'test')">テスト</button>
      <button class="tab-button" onclick="openTab(event, 'logs')">ログ</button>
    </div>
    
    <!-- 診断タブ -->
    <div id="diagnosis" class="tab-content active">
      <h2>現在の状態を診断</h2>
      <p>現在のユーザー状態を診断し、問題点を特定します。</p>
      
      <button id="diagnoseState">現在の状態を診断</button>
      <button id="checkLocalStorage" class="secondary">ローカルストレージを確認</button>
      <button id="checkSessionStorage" class="secondary">セッションストレージを確認</button>
      <button id="checkSupabaseMetadata" class="secondary">Supabaseメタデータを確認</button>
      
      <div id="diagnosisResult" class="result" style="display: none;"></div>
    </div>
    
    <!-- 修正タブ -->
    <div id="fix" class="tab-content">
      <h2>問題を修正</h2>
      <p>診断結果に基づいて問題を修正します。</p>
      
      <button id="resetMetadata">メタデータをリセット</button>
      <button id="clearLocalStorage">ローカルストレージをクリア</button>
      <button id="clearSessionStorage">セッションストレージをクリア</button>
      <button id="fixInvitedStatus" class="secondary">招待ステータスを修正</button>
      <button id="fixAll" class="danger">すべて修正</button>
      
      <div id="fixResult" class="result" style="display: none;"></div>
    </div>
    
    <!-- テストタブ -->
    <div id="test" class="tab-content">
      <h2>修正結果をテスト</h2>
      <p>修正後の状態をテストします。</p>
      
      <button id="testLogin">ログインテスト</button>
      <button id="testInviteFlow">招待フローテスト</button>
      <button id="simulateCallback">コールバックシミュレーション</button>
      
      <div id="testResult" class="result" style="display: none;"></div>
    </div>
    
    <!-- ログタブ -->
    <div id="logs" class="tab-content">
      <h2>デバッグログ</h2>
      <p>実行されたアクションのログを表示します。</p>
      
      <button id="clearLogs" class="secondary">ログをクリア</button>
      <button id="exportLogs" class="secondary">ログをエクスポート</button>
      
      <div class="log-container">
        <div id="logEntries"></div>
      </div>
    </div>
  </div>
  
  <script>
    // Supabaseクライアントの初期化
    const supabaseUrl = 'https://rlxlpjrqfgcfmgbhqpnj.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJseGxwanJxZmdjZm1nYmhxcG5qIiwicm9sZSI6ImFub24iLCJpYXQiOjE2OTk0MzA0NzcsImV4cCI6MjAxNTAwNjQ3N30.Nh83ebqzv3RZkOmvlMN0SQnCuOp1ZKbKiJOvCGYJpSA';
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
    
    // ログ機能
    const logs = [];
    
    function log(level, message, data = null) {
      const timestamp = new Date().toISOString();
      const logEntry = { timestamp, level, message, data };
      logs.push(logEntry);
      
      // ログエントリを表示
      const logEntriesDiv = document.getElementById('logEntries');
      const entryDiv = document.createElement('div');
      entryDiv.className = `log-entry ${level}`;
      
      let logText = `[${timestamp}] [${level.toUpperCase()}] ${message}`;
      if (data) {
        if (typeof data === 'object') {
          logText += `\n${JSON.stringify(data, null, 2)}`;
        } else {
          logText += `\n${data}`;
        }
      }
      
      entryDiv.textContent = logText;
      logEntriesDiv.appendChild(entryDiv);
      logEntriesDiv.scrollTop = logEntriesDiv.scrollHeight;
      
      return logEntry;
    }
    
    // タブ切り替え機能
    function openTab(evt, tabName) {
      const tabContents = document.getElementsByClassName('tab-content');
      for (let i = 0; i < tabContents.length; i++) {
        tabContents[i].classList.remove('active');
      }
      
      const tabButtons = document.getElementsByClassName('tab-button');
      for (let i = 0; i < tabButtons.length; i++) {
        tabButtons[i].classList.remove('active');
      }
      
      document.getElementById(tabName).classList.add('active');
      evt.currentTarget.classList.add('active');
    }
    
    // 結果表示用の関数
    function showResult(containerId, message, type = 'info') {
      const resultDiv = document.getElementById(containerId);
      resultDiv.innerHTML = message;
      resultDiv.style.display = 'block';
      
      // クラスをリセット
      resultDiv.classList.remove('error', 'warning', 'info');
      
      // 適切なクラスを追加
      if (type === 'error') {
        resultDiv.classList.add('error');
      } else if (type === 'warning') {
        resultDiv.classList.add('warning');
      } else {
        resultDiv.classList.add('info');
      }
    }
    
    // 診断機能
    async function diagnoseState() {
      try {
        log('info', '現在の状態を診断中...');
        
        // 1. Supabaseセッションを確認
        const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
        
        if (sessionError) {
          log('error', 'セッション取得エラー', sessionError);
          showResult('diagnosisResult', `
            <h3>エラー: セッション取得に失敗</h3>
            <p>Supabaseセッションの取得中にエラーが発生しました。</p>
            <pre>${JSON.stringify(sessionError, null, 2)}</pre>
          `, 'error');
          return;
        }
        
        if (!session) {
          log('warn', 'アクティブなセッションがありません');
          showResult('diagnosisResult', `
            <h3>警告: セッションなし</h3>
            <p>アクティブなSupabaseセッションが見つかりません。ログインしていない可能性があります。</p>
            <p>ログインしてから再度診断を実行してください。</p>
          `, 'warning');
          return;
        }
        
        // 2. ユーザー情報を取得
        const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
        
        if (userError || !user) {
          log('error', 'ユーザー情報取得エラー', userError);
          showResult('diagnosisResult', `
            <h3>エラー: ユーザー情報の取得に失敗</h3>
            <p>Supabaseからユーザー情報を取得できませんでした。</p>
            <pre>${JSON.stringify(userError, null, 2)}</pre>
          `, 'error');
          return;
        }
        
        log('info', 'ユーザー情報を取得しました', {
          id: user.id,
          email: user.email,
          metadata: user.user_metadata
        });
        
        // 3. ローカルストレージを確認
        const localStorageData = {};
        const relevantKeys = [
          'kaizen_user_info',
          'kaizen_users',
          'invite_token',
          'invite_company_id'
        ];
        
        for (const key of relevantKeys) {
          const value = localStorage.getItem(key);
          localStorageData[key] = value ? JSON.parse(value) : null;
        }
        
        log('info', 'ローカルストレージを確認しました', localStorageData);
        
        // 4. セッションストレージを確認
        const sessionStorageData = {};
        
        for (const key of relevantKeys) {
          const value = sessionStorage.getItem(key);
          sessionStorageData[key] = value ? JSON.parse(value) : null;
        }
        
        log('info', 'セッションストレージを確認しました', sessionStorageData);
        
        // 5. 問題を診断
        const issues = [];
        
        // 5.1 メタデータの問題を確認
        const userMetadata = user.user_metadata || {};
        
        if (userMetadata.isInvited === true) {
          issues.push({
            type: 'error',
            message: 'メタデータの isInvited フラグが true になっています',
            fix: 'resetMetadata'
          });
        }
        
        // 5.2 ローカルストレージの問題を確認
        const localUserInfo = localStorageData['kaizen_user_info'];
        
        if (localUserInfo && localUserInfo.isInvited === true) {
          issues.push({
            type: 'error',
            message: 'ローカルストレージの isInvited フラグが true になっています',
            fix: 'clearLocalStorage'
          });
        }
        
        // 5.3 招待トークンが残っていないか確認
        if (localStorage.getItem('invite_token') || sessionStorage.getItem('invite_token')) {
          issues.push({
            type: 'warning',
            message: '招待トークンがストレージに残っています',
            fix: 'clearLocalStorage'
          });
        }
        
        // 5.4 ステータスの不整合を確認
        if (localUserInfo && localUserInfo.status !== 'アクティブ' && localUserInfo.status !== '招待中') {
          issues.push({
            type: 'warning',
            message: `ステータスが不正な値です: ${localUserInfo.status}`,
            fix: 'fixInvitedStatus'
          });
        }
        
        // 5.5 ユーザーリストの問題を確認
        const usersList = localStorageData['kaizen_users'];
        
        if (usersList) {
          const currentUserInList = usersList.find(item => 
            item.user && item.user.id === user.id
          );
          
          if (currentUserInList && currentUserInList.user.isInvited === true) {
            issues.push({
              type: 'error',
              message: 'ユーザーリスト内の isInvited フラグが true になっています',
              fix: 'clearLocalStorage'
            });
          }
          
          if (currentUserInList && currentUserInList.user.status !== 'アクティブ' && currentUserInList.user.status !== '招待中') {
            issues.push({
              type: 'warning',
              message: `ユーザーリスト内のステータスが不正な値です: ${currentUserInList.user.status}`,
              fix: 'fixInvitedStatus'
            });
          }
        }
        
        // 診断結果を表示
        if (issues.length === 0) {
          log('info', '問題は見つかりませんでした');
          showResult('diagnosisResult', `
            <h3>診断結果: 問題なし</h3>
            <p>現在の状態に問題は見つかりませんでした。招待フローの無限ループは発生しないはずです。</p>
            <h4>ユーザー情報</h4>
            <pre>${JSON.stringify({
              id: user.id,
              email: user.email,
              metadata: user.user_metadata
            }, null, 2)}</pre>
          `, 'info');
        } else {
          log('warn', '問題が見つかりました', issues);
          
          let issuesHtml = '';
          for (const issue of issues) {
            issuesHtml += `
              <div class="${issue.type}">
                <p><strong>${issue.message}</strong></p>
                <p>推奨される修正: ${getFixButtonName(issue.fix)}</p>
              </div>
            `;
          }
          
          showResult('diagnosisResult', `
            <h3>診断結果: ${issues.length}件の問題が見つかりました</h3>
            <p>以下の問題が見つかりました。「修正」タブで修正することをお勧めします。</p>
            ${issuesHtml}
            <h4>ユーザー情報</h4>
            <pre>${JSON.stringify({
              id: user.id,
              email: user.email,
              metadata: user.user_metadata
            }, null, 2)}</pre>
          `, issues.some(i => i.type === 'error') ? 'error' : 'warning');
        }
      } catch (error) {
        log('error', '診断中にエラーが発生しました', error);
        showResult('diagnosisResult', `
          <h3>エラー: 診断に失敗しました</h3>
          <p>診断中に予期しないエラーが発生しました。</p>
          <pre>${error.message || JSON.stringify(error, null, 2)}</pre>
        `, 'error');
      }
    }
    
    // 修正ボタン名を取得
    function getFixButtonName(fixId) {
      switch (fixId) {
        case 'resetMetadata':
          return 'メタデータをリセット';
        case 'clearLocalStorage':
          return 'ローカルストレージをクリア';
        case 'clearSessionStorage':
          return 'セッションストレージをクリア';
        case 'fixInvitedStatus':
          return '招待ステータスを修正';
        case 'fixAll':
          return 'すべて修正';
        default:
          return fixId;
      }
    }
    
    // ローカルストレージを確認
    function checkLocalStorage() {
      try {
        log('info', 'ローカルストレージを確認中...');
        
        const localStorageData = {};
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          try {
            const value = localStorage.getItem(key);
            localStorageData[key] = JSON.parse(value);
          } catch (e) {
            localStorageData[key] = localStorage.getItem(key);
          }
        }
        
        log('info', 'ローカルストレージの内容', localStorageData);
        
        showResult('diagnosisResult', `
          <h3>ローカルストレージの内容</h3>
          <pre>${JSON.stringify(localStorageData, null, 2)}</pre>
        `, 'info');
      } catch (error) {
        log('error', 'ローカルストレージの確認中にエラーが発生しました', error);
        showResult('diagnosisResult', `
          <h3>エラー: ローカルストレージの確認に失敗しました</h3>
          <p>ローカルストレージの確認中に予期しないエラーが発生しました。</p>
          <pre>${error.message || JSON.stringify(error, null, 2)}</pre>
        `, 'error');
      }
    }
    
    // セッションストレージを確認
    function checkSessionStorage() {
      try {
        log('info', 'セッションストレージを確認中...');
        
        const sessionStorageData = {};
        for (let i = 0; i < sessionStorage.length; i++) {
          const key = sessionStorage.key(i);
          try {
            const value = sessionStorage.getItem(key);
            sessionStorageData[key] = JSON.parse(value);
          } catch (e) {
            sessionStorageData[key] = sessionStorage.getItem(key);
          }
        }
        
        log('info', 'セッションストレージの内容', sessionStorageData);
        
        showResult('diagnosisResult', `
          <h3>セッションストレージの内容</h3>
          <pre>${JSON.stringify(sessionStorageData, null, 2)}</pre>
        `, 'info');
      } catch (error) {
        log('error', 'セッションストレージの確認中にエラーが発生しました', error);
        showResult('diagnosisResult', `
          <h3>エラー: セッションストレージの確認に失敗しました</h3>
          <p>セッションストレージの確認中に予期しないエラーが発生しました。</p>
          <pre>${error.message || JSON.stringify(error, null, 2)}</pre>
        `, 'error');
      }
    }
    
    // Supabaseメタデータを確認
    async function checkSupabaseMetadata() {
      try {
        log('info', 'Supabaseメタデータを確認中...');
        
        // ユーザー情報を取得
        const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
        
        if (userError || !user) {
          log('error', 'ユーザー情報取得エラー', userError);
          showResult('diagnosisResult', `
            <h3>エラー: ユーザー情報の取得に失敗</h3>
            <p>Supabaseからユーザー情報を取得できませんでした。</p>
            <pre>${JSON.stringify(userError, null, 2)}</pre>
          `, 'error');
          return;
        }
        
        log('info', 'Supabaseメタデータを取得しました', user.user_metadata);
        
        showResult('diagnosisResult', `
          <h3>Supabaseメタデータの内容</h3>
          <pre>${JSON.stringify(user.user_metadata, null, 2)}</pre>
        `, 'info');
      } catch (error) {
        log('error', 'Supabaseメタデータの確認中にエラーが発生しました', error);
        showResult('diagnosisResult', `
          <h3>エラー: Supabaseメタデータの確認に失敗しました</h3>
          <p>Supabaseメタデータの確認中に予期しないエラーが発生しました。</p>
          <pre>${error.message || JSON.stringify(error, null, 2)}</pre>
        `, 'error');
      }
    }
    
    // メタデータをリセット
    async function resetMetadata() {
      try {
        log('info', 'メタデータをリセット中...');
        
        // 現在のセッションを取得
        const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
        
        if (sessionError || !session) {
          log('error', 'セッション取得エラー', sessionError);
          showResult('fixResult', `
            <h3>エラー: セッション取得に失敗</h3>
            <p>Supabaseセッションの取得中にエラーが発生しました。</p>
            <pre>${JSON.stringify(sessionError, null, 2)}</pre>
          `, 'error');
          return;
        }
        
        // ユーザーメタデータを更新
        const { error: updateError } = await supabaseClient.auth.updateUser({
          data: {
            isInvited: false,
            status: 'アクティブ'
          }
        });
        
        if (updateError) {
          log('error', 'メタデータの更新に失敗しました', updateError);
          showResult('fixResult', `
            <h3>エラー: メタデータの更新に失敗しました</h3>
            <p>Supabaseユーザーメタデータの更新中にエラーが発生しました。</p>
            <pre>${JSON.stringify(updateError, null, 2)}</pre>
          `, 'error');
          return;
        }
        
        log('info', 'メタデータを正常に更新しました');
        
        showResult('fixResult', `
          <h3>メタデータを正常に更新しました</h3>
          <p>以下の値に設定されました：</p>
          <pre>
{
  "isInvited": false,
  "status": "アクティブ"
}
          </pre>
          <p>これにより招待フローの無限ループが解消されるはずです。</p>
        `, 'info');
      } catch (error) {
        log('error', 'メタデータのリセット中にエラーが発生しました', error);
        showResult('fixResult', `
          <h3>エラー: メタデータのリセットに失敗しました</h3>
          <p>メタデータのリセット中に予期しないエラーが発生しました。</p>
          <pre>${error.message || JSON.stringify(error, null, 2)}</pre>
        `, 'error');
      }
    }
    
    // ローカルストレージをクリア
    function clearLocalStorage() {
      try {
        log('info', 'ローカルストレージをクリア中...');
        
        // 招待関連のデータをクリア
        localStorage.removeItem('invite_token');
        localStorage.removeItem('invite_company_id');
        
        // ユーザーデータを取得して修正
        const userDataKey = 'kaizen_user_info';
        const usersKey = 'kaizen_users';
        
        // 現在のユーザー情報を取得
        const userData = localStorage.getItem(userDataKey);
        if (userData) {
          try {
            const user = JSON.parse(userData);
            // isInvited を false に、status を「アクティブ」に設定
            user.isInvited = false;
            user.status = 'アクティブ';
            // 更新したデータを保存
            localStorage.setItem(userDataKey, JSON.stringify(user));
            
            log('info', 'ユーザーデータを修正しました', user);
          } catch (e) {
            log('error', 'ユーザーデータの解析に失敗:', e);
          }
        }
        
        // ユーザーリストを取得して修正
        const usersData = localStorage.getItem(usersKey);
        if (usersData) {
          try {
            const users = JSON.parse(usersData);
            // 各ユーザーの isInvited と status を更新
            const updatedUsers = users.map(item => {
              if (item.user) {
                return {
                  ...item,
                  user: {
                    ...item.user,
                    isInvited: false,
                    status: item.user.status === '招待中' ? '招待中' : 'アクティブ'
                  }
                };
              }
              return item;
            });
            // 更新したデータを保存
            localStorage.setItem(usersKey, JSON.stringify(updatedUsers));
            
            log('info', 'ユーザーリストを修正しました', updatedUsers);
          } catch (e) {
            log('error', 'ユーザーリストの解析に失敗:', e);
          }
        }
        
        log('info', 'ローカルストレージをクリアしました');
        
        showResult('fixResult', `
          <h3>ローカルストレージをクリアしました</h3>
          <p>以下のデータが削除または修正されました：</p>
          <ul>
            <li>invite_token</li>
            <li>invite_company_id</li>
            <li>ユーザーデータの isInvited フラグを false に設定</li>
            <li>ユーザーデータの status を「アクティブ」に設定（招待中のユーザーを除く）</li>
          </ul>
        `, 'info');
      } catch
